#cloud-config
autoinstall:
  version: 1

  locale: pt_BR.UTF-8
  keyboard:
    layout: br

  timezone: America/Sao_Paulo

  # ===============================================
  # USO TOTAL DO DISCO
  # ===============================================
  storage:
    layout:
      name: lvm  

  # ===============================================
  # LÓGICA PARA NOMEAR MAQUINAS
  # ===============================================
  identity:
    hostname: implant-workstation-01
    username: admings
    password: "$6$kO6Dl0JIi4pLithw$YuWkSmm3m0PSO2fbJ7P6dF7hNV6AuFKgTXbFJoSRnJNvsvokFZG.yLjOOeQZznlz487YvDAN9U2Q3HPy9SE7Y/"

  # ===============================================
  # PACOTES
  # ===============================================
  packages:
    - git
    - vim
    - curl
    - wget
    - gpg
    - openssh-server
    - freeipa-client
    - oddjob-mkhomedir
    - ubuntu-restricted-extras
    - ffmpeg
    - gstreamer1.0-plugins-base
    - gstreamer1.0-plugins-good
    - gstreamer1.0-plugins-bad
    - gstreamer1.0-plugins-ugly
    - gstreamer1.0-libav
    - gstreamer1.0-tools
    - gstreamer1.0-x
    - gstreamer1.0-alsa
    - gstreamer1.0-pulseaudio
    - flatpak
    - libreoffice-l10n-pt-br
    - libreoffice-help-pt-br
    - hunspell-pt-br

  # ===============================================
  # APLICAR ARQUIVOS
  # ===============================================
  user-data:
    write_files:
      - path: /etc/polkit-1/rules.d/40-regras-personalizadas.rules
        permissions: 0644
        owner: root:root
        content: |
          /* Permite que usuários no grupo 'powerusers' desliguem/reiniciem sem senha */
          polkit.addRule(function(action, subject) {
              if ((action.id == "org.freedesktop.login1.power-off" ||
                   action.id == "org.freedesktop.login1.reboot") &&
                  subject.isInGroup("powerusers")) {
                  return polkit.Result.YES;
              }
          });

      - path: /usr/local/bin/setup-user-repo.sh
        permissions: 0755
        owner: root:root
        content: |
          #!/bin/bash
          LOCK_FILE="$HOME/.config/repo_setup_complete"
          if [ ! -f "$LOCK_FILE" ]; then
              REPO_URL="https://github.com/giusoft/FreeIPA.git"
              DEST_DIR="$HOME/minhas-configs"
              /usr/bin/git clone --branch rustdesk --single-branch "$REPO_URL" "$DEST_DIR"
              if [ $? -eq 0 ]; then
                  mkdir -p "$HOME/.config"
                  touch "$LOCK_FILE"
              fi
          fi

      - path: /etc/skel/.config/autostart/setup-repo.desktop
        permissions: 0644
        owner: root:root
        content: |
          [Desktop Entry]
          Type=Application
          Name=Setup Inicial do Repositório
          Comment=Clona o repositório de configurações no primeiro login
          Exec=/usr/local/bin/setup-user-repo.sh
          Terminal=false
          Hidden=false

  # ===============================================
  # PÓS-INSTALAÇÃO 
  # ===============================================
  late-commands:
    # Configura o repositório do RustDesk
    - curtin in-target -- install -m 0755 -d /etc/apt/keyrings
    - curtin in-target -- /bin/sh -c "wget -O - https://rustdesk.com/rustdesk.gpg.key | gpg --dearmor -o /etc/apt/keyrings/rustdesk.gpg"
    - curtin in-target -- /bin/sh -c 'echo "deb [signed-by=/etc/apt/keyrings/rustdesk.gpg] https://rustdesk.com/download/linux/deb/nightly ./" > /etc/apt/sources.list.d/rustdesk.list'
    
    # Aceita o EULA das fontes Microsoft
    - curtin in-target -- /bin/sh -c 'echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections'
    
    # Instala o RustDesk
    - curtin in-target -- apt update
    - curtin in-target -- apt install -y rustdesk

    # Cria o grupo powerusers
    - curtin in-target -- groupadd powerusers

    # Habilita SSH (o pacote 'openssh-server' já está na lista 'packages')
    - curtin in-target -- systemctl enable --now ssh

    # Instala o Tailscale via script oficial
    - curtin in-target -- /bin/sh -c "curl -fsSL https://tailscale.com/install.sh | sh"
    
    # Ativa e inicia o serviço Tailscale
    - curtin in-target -- systemctl enable --now tailscaled

  # ===============================================
  # CONFIGURAÇÃO DE REDE
  # ===============================================
  network:
    version: 2
    ethernets:
      id0:
        match:
          name: "e*"
        dhcp4: true
        dhcp4-overrides:
          use-dns: false
        nameservers:
          addresses: [192.168.1.199]
